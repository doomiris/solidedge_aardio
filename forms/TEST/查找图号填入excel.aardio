import console; 
console.open();

import config;
import sqlite;
var db = sqlite(io.joinpath(config.dbServer.path,"drawing_lists.db"));

var getDrawingNumber = function(pcode){
	if #pcode !== 11 return null; 
	var t = db.stepQuery("SELECT * FROM [Map]", {专用号 = string.trimleft(pcode, "H")})
	if t return "H" ++ t.图号;
	else return null;
}
var getDrawingFile= function(pcode){
	var t = db.stepQuery(`SELECT * FROM [Lib] WHERE 文件名 LIKE "%` ++ string.trimleft(pcode, "H") ++ `%"`);
	if t return pcode;
	else return null;
}
var getDrawingRevision= function(pcode){
	var sdb,err = sqlite(io.joinpath(config.dbServer.path,"qhc_dw_rel_list.db"),,1/*_SQLITE_OPEN_READONLY*/);	//打开数据库连接
	pcode = string.trim(pcode);
	if !pcode return null ; 	
    if !(string.startWith(pcode,"H",true)) pcode = "H" ++ pcode;
	var tab = sdb.getTable("SELECT * FROM [qhc_dw_rel_list]", { 物料号码 = pcode } );
	if !#tab return ""; 
	table.sort(tab, lambda(next) tonumber(owner.图纸版次) < tonumber(next.图纸版次));	
	return tab[#tab].图纸版次;
}

import com.excel;
var excel = com.excel(false);

import console.progress
var progress = console.progress();

var sht = excel.ActiveWorkbook.ActiveSheet;
excel.alerts = false;
var count = sht.usedRange.rows.count;

//_checkFolder = "D:\workspaces\danaos\"

//import fsys;

_P_COL = 2 /* b */	//查找专用号所在列
_D_COL = 1 /* a */	//图号填入列
_R_COL = 5 /* e */	//版本填入列


for (i=2; count){
	progress.setProgress( i/count * 100 );
	var p = sht.cells(i, _P_COL).value2;
	if !p continue;
	if !#p continue;
	
	var d = getDrawingNumber(p) : getDrawingFile(p);
	if d sht.cells(i, _D_COL).value2 = d;
	sht.cells(i, _R_COL).value2 = getDrawingRevision(p);
}
excel.alerts = true;
db.close();
console.pause(true);
